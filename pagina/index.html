<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megapersonals Premium</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { box-shadow: 0 0 40px rgba(147, 51, 234, 0.8); }
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-gradient { 
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .paused-overlay {
            position: relative;
        }
        .paused-overlay::after {
            content: '‚è∏Ô∏è PAUSADO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 165, 0, 0.95);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
        }
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }
        .screenshot-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        .screenshot-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ==================== CONFIG ====================
        const ADMIN_PASSWORD = "admin123";
        
        const firebaseConfig = {
            databaseURL: "https://megapersonals-4f24c-default-rtdb.firebaseio.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CONTACT = {
            whatsapp: "18293837695",
            email: "angel15dobleu@gmail.com"
        };

        const SERVICES = [
            {
                id: 'proxy',
                icon: 'üöÄ',
                title: 'Proxies Premium',
                subtitle: 'Los mejores',
                description: 'R√°pidos y confiables.',
                features: ['Alta velocidad', 'IP dedicadas', 'Soporte 24/7', 'Uptime 99.9%'],
                price: '$15/mes',
                stock: 15
            },
            {
                id: 'sale',
                icon: 'üíé',
                title: 'Cuentas Venta',
                subtitle: 'Verificadas',
                description: 'Listas para usar.',
                features: ['100% verificadas', 'Sin restricciones', 'Inmediata', 'Garant√≠a'],
                price: 'Consultar',
                stock: 8
            },
            {
                id: 'rental',
                icon: '‚ö°',
                title: 'Renta',
                subtitle: 'Flexible',
                description: 'Por d√≠a o semana.',
                features: ['Sin compromisos', 'Renovable', 'Soporte', 'R√°pido'],
                price: '$30/d√≠a - $140/semana',
                stock: 20
            }
        ];

        // ==================== SONIDOS ====================
        const playSuccessSound = () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator1 = audioContext.createOscillator();
            const gainNode1 = audioContext.createGain();
            oscillator1.connect(gainNode1);
            gainNode1.connect(audioContext.destination);
            oscillator1.frequency.value = 523.25;
            oscillator1.type = 'sine';
            gainNode1.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            oscillator1.start(audioContext.currentTime);
            oscillator1.stop(audioContext.currentTime + 0.2);
            
            const oscillator2 = audioContext.createOscillator();
            const gainNode2 = audioContext.createGain();
            oscillator2.connect(gainNode2);
            gainNode2.connect(audioContext.destination);
            oscillator2.frequency.value = 659.25;
            oscillator2.type = 'sine';
            gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.1);
            gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator2.start(audioContext.currentTime + 0.1);
            oscillator2.stop(audioContext.currentTime + 0.3);
        };

        const createConfetti = () => {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        };

        // ==================== FIREBASE API ====================
        const FirebaseAPI = {
            async createManualUser(browserName, days, hours) {
                try {
                    const now = new Date();
                    const expirationDate = new Date(now);
                    expirationDate.setDate(expirationDate.getDate() + parseInt(days));
                    expirationDate.setHours(expirationDate.getHours() + parseInt(hours));

                    // Generar ID √∫nico de 8 caracteres
                    const uniqueId = Math.random().toString(36).substring(2, 10).toUpperCase();

                    const userData = {
                        browserName: browserName,
                        uniqueId: uniqueId,
                        phoneNumber: "Manual",
                        city: "Manual",
                        location: "Manual",
                        isPaused: false,
                        rentalExpiration: expirationDate.toISOString(),
                        rentalRemaining: this.calculateRentalRemaining(expirationDate.toISOString()),
                        republishStatus: {
                            totalSeconds: 900,
                            elapsedSeconds: 0,
                            remainingSeconds: 900,
                            nextRepublishAt: new Date(now.getTime() + 900000).toISOString()
                        },
                        lastUpdate: now.toISOString(),
                        manuallyCreated: true
                    };

                    await database.ref(`browsers/${browserName}`).set(userData);
                    
                    return { success: true, uniqueId };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },

            async generateUniqueId(browserName) {
                try {
                    // Generar ID √∫nico de 8 caracteres
                    const uniqueId = Math.random().toString(36).substring(2, 10).toUpperCase();
                    
                    // Actualizar el browser con el nuevo uniqueId
                    await database.ref(`browsers/${browserName}/uniqueId`).set(uniqueId);
                    
                    return uniqueId;
                } catch (error) {
                    console.error('Error generando uniqueId:', error);
                    return null;
                }
            },

            async findBrowserByUniqueId(uniqueId) {
                try {
                    const snapshot = await database.ref('browsers').once('value');
                    const browsers = snapshot.val();
                    
                    if (!browsers) return null;
                    
                    // Buscar el browser que tenga este uniqueId
                    for (const [name, data] of Object.entries(browsers)) {
                        if (data.uniqueId === uniqueId) {
                            return data;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    return null;
                }
            },

            calculateRentalRemaining(rentalExpiration) {
                const diff = new Date(rentalExpiration) - new Date();
                if (diff <= 0) return { days: 0, hours: 0, minutes: 0 };
                return {
                    days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                    hours: Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
                    minutes: Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))
                };
            },

            async getAllBrowsers() {
                try {
                    const snapshot = await database.ref('browsers').once('value');
                    return snapshot.val() || {};
                } catch (error) {
                    return {};
                }
            },

            listenToAllBrowsers(callback) {
                const ref = database.ref('browsers');
                ref.on('value', (snapshot) => {
                    callback(snapshot.val() || {});
                });
                return () => ref.off('value');
            },

            async findBrowserByName(browserName) {
                try {
                    const snapshot = await database.ref(`browsers/${browserName}`).once('value');
                    return snapshot.val();
                } catch (error) {
                    return null;
                }
            },

            async findBrowser(phoneNumber) {
                try {
                    const snapshot = await database.ref('browsers').once('value');
                    const browsers = snapshot.val();
                    if (!browsers) return null;
                    
                    const cleanPhone = phoneNumber.replace(/\D/g, '');
                    
                    // Primero intentar b√∫squeda exacta
                    for (const [name, data] of Object.entries(browsers)) {
                        const browserPhone = (data.phoneNumber || '').replace(/\D/g, '');
                        if (browserPhone === cleanPhone) {
                            return data;
                        }
                    }
                    
                    // Si no encuentra exacto, buscar que termine con los d√≠gitos (√∫ltimos 10 d√≠gitos)
                    if (cleanPhone.length >= 10) {
                        const last10 = cleanPhone.slice(-10);
                        for (const [name, data] of Object.entries(browsers)) {
                            const browserPhone = (data.phoneNumber || '').replace(/\D/g, '');
                            if (browserPhone.endsWith(last10)) {
                                return data;
                            }
                        }
                    }
                    
                    return null;
                } catch (error) {
                    return null;
                }
            },
            
            async sendCommand(browserName, actionType, payload = {}) {
                try {
                    const commandId = Date.now().toString();
                    await database.ref(`commands/${browserName}/${commandId}`).set({
                        type: actionType,
                        ...payload,
                        timestamp: new Date().toISOString()
                    });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            listenToBrowser(browserName, callback) {
                const ref = database.ref(`browsers/${browserName}`);
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) callback(data);
                });
                return () => ref.off('value');
            }
        };

        // ==================== ICONOS ====================
        const MessageCircle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>);
        const X = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const Send = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>);
        const Search = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>);
        const Pause = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>);
        const Play = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>);
        const RefreshCw = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>);
        const Camera = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>);
        const Lock = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>);
        const Link = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>);
        const Plus = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const Edit = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>);

        // ==================== UTILIDADES ====================
        const formatTime = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        };

        const formatRentalTime = (rental) => {
            if (!rental || rental.days === -1) return "Sin renta";
            if (rental.days === 0 && rental.hours === 0 && rental.minutes === 0) return "Expirada";
            const parts = [];
            if (rental.days > 0) parts.push(`${rental.days}d`);
            if (rental.hours > 0) parts.push(`${rental.hours}h`);
            if (rental.minutes > 0) parts.push(`${rental.minutes}m`);
            return parts.join(', ');
        };

        const getRentalColor = (rental) => {
            if (!rental || rental.days === -1) return 'text-gray-500';
            if (rental.days === 0 && rental.hours === 0) return 'text-red-600';
            if (rental.days === 0) return 'text-orange-500';
            if (rental.days < 2) return 'text-yellow-500';
            return 'text-green-600';
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Link copiado');
            }).catch(() => {
                prompt('Copia este link:', text);
            });
        };

        // ==================== ADMIN PANEL ====================
        const AdminPanel = ({ isAuthenticated, onLogin }) => {
            const [browsers, setBrowsers] = useState({});
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [selectedBrowser, setSelectedBrowser] = useState(null);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [newUser, setNewUser] = useState({ name: '', days: '', hours: '' });
            const [creating, setCreating] = useState(false);

            useEffect(() => {
                if (isAuthenticated) {
                    const unsubscribe = FirebaseAPI.listenToAllBrowsers(setBrowsers);
                    return unsubscribe;
                }
            }, [isAuthenticated]);

            const handleLogin = () => {
                if (password === ADMIN_PASSWORD) {
                    onLogin();
                    setError('');
                } else {
                    setError('Contrase√±a incorrecta');
                }
            };

            const handleCreateUser = async () => {
                if (!newUser.name.trim()) {
                    alert('‚ùå Ingresa un nombre');
                    return;
                }
                
                const days = parseInt(newUser.days) || 0;
                const hours = parseInt(newUser.hours) || 0;
                
                if (days === 0 && hours === 0) {
                    alert('‚ùå Ingresa d√≠as u horas');
                    return;
                }

                setCreating(true);
                const result = await FirebaseAPI.createManualUser(newUser.name.trim(), days, hours);
                
                if (result.success) {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const userLink = `${baseUrl}?id=${result.uniqueId}`;
                    
                    // Copiar link autom√°ticamente
                    copyToClipboard(userLink);
                    
                    alert(`‚úÖ Usuario "${newUser.name}" creado\n\nüîó Link copiado:\n${userLink}\n\nüìã ID: ${result.uniqueId}`);
                    setNewUser({ name: '', days: '', hours: '' });
                    setShowCreateForm(false);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
                
                setCreating(false);
            };

            const generateUserLink = (browser) => {
                const baseUrl = window.location.origin + window.location.pathname;
                
                // Si tiene uniqueId, usar link √∫nico
                if (browser.uniqueId) {
                    return `${baseUrl}?id=${encodeURIComponent(browser.uniqueId)}`;
                }
                
                // Si no tiene uniqueId, usar browserName (usuarios antiguos)
                const browserName = browser.browserName || browser.name;
                return `${baseUrl}?user=${encodeURIComponent(browserName)}`;
            };

            const handleCopyLink = async (browser) => {
                const browserName = browser.browserName || browser.name;
                
                // Si no tiene uniqueId, generarlo
                if (!browser.uniqueId) {
                    const uniqueId = await FirebaseAPI.generateUniqueId(browserName);
                    if (uniqueId) {
                        // Actualizar el browser en el estado local
                        browser.uniqueId = uniqueId;
                        alert(`‚úÖ ID √∫nico generado: ${uniqueId}`);
                    } else {
                        alert('‚ùå Error generando ID √∫nico');
                        return;
                    }
                }
                
                // Generar y copiar el link
                const link = generateUserLink(browser);
                copyToClipboard(link);
            };

            if (!isAuthenticated) {
                return (
                    <div className="glass rounded-3xl p-12 max-w-md mx-auto">
                        <div className="text-center mb-8">
                            <div className="mx-auto mb-4 flex justify-center"><Lock /></div>
                            <h2 className="text-3xl font-bold text-white mb-2">Panel Admin</h2>
                        </div>
                        
                        <div className="space-y-4">
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                placeholder="Contrase√±a"
                                className="w-full px-6 py-4 rounded-xl text-lg"
                            />
                            
                            {error && (
                                <div className="bg-red-100 border-2 border-red-300 text-red-700 px-4 py-3 rounded-xl text-center">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                onClick={handleLogin}
                                className="w-full bg-white text-purple-600 px-6 py-4 rounded-xl font-bold"
                            >
                                Ingresar
                            </button>
                        </div>
                    </div>
                );
            }

            const browserList = Object.entries(browsers).map(([name, data]) => ({
                name,
                ...data
            }));

            browserList.sort((a, b) => {
                const getRentalDays = (browser) => {
                    if (!browser.rentalRemaining || browser.rentalRemaining.days === -1) return 999;
                    return browser.rentalRemaining.days + (browser.rentalRemaining.hours / 24);
                };
                return getRentalDays(a) - getRentalDays(b);
            });

            return (
                <div className="space-y-6">
                    <div className="glass rounded-2xl p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-white">‚ûï Crear Usuario</h3>
                            <button
                                onClick={() => setShowCreateForm(!showCreateForm)}
                                className="bg-white text-purple-600 px-6 py-3 rounded-xl font-bold flex items-center gap-2"
                            >
                                <Plus /> {showCreateForm ? 'Cancelar' : 'Nuevo'}
                            </button>
                        </div>

                        {showCreateForm && (
                            <div className="bg-white bg-opacity-10 rounded-xl p-6 space-y-4">
                                <input
                                    type="text"
                                    value={newUser.name}
                                    onChange={(e) => setNewUser({...newUser, name: e.target.value})}
                                    placeholder="Nombre"
                                    className="w-full px-4 py-3 rounded-xl"
                                />
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <input
                                        type="number"
                                        value={newUser.days}
                                        onChange={(e) => setNewUser({...newUser, days: e.target.value})}
                                        placeholder="D√≠as"
                                        min="0"
                                        className="w-full px-4 py-3 rounded-xl"
                                    />
                                    <input
                                        type="number"
                                        value={newUser.hours}
                                        onChange={(e) => setNewUser({...newUser, hours: e.target.value})}
                                        placeholder="Horas"
                                        min="0"
                                        className="w-full px-4 py-3 rounded-xl"
                                    />
                                </div>

                                <button
                                    onClick={handleCreateUser}
                                    disabled={creating}
                                    className="w-full bg-green-500 text-white px-6 py-4 rounded-xl font-bold disabled:opacity-50"
                                >
                                    {creating ? 'Creando...' : '‚úÖ Crear'}
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="glass rounded-3xl p-6">
                        <h2 className="text-2xl font-bold text-white mb-6">üìä Usuarios</h2>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-white border-opacity-20">
                                        <th className="text-left py-4 px-4 text-white font-bold">Navegador</th>
                                        <th className="text-left py-4 px-4 text-white font-bold">Tel√©fono</th>
                                        <th className="text-left py-4 px-4 text-white font-bold">Renta</th>
                                        <th className="text-center py-4 px-4 text-white font-bold">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {browserList.map((browser, idx) => (
                                        <tr key={idx} className="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-10">
                                            <td className="py-4 px-4 text-white font-bold">{browser.browserName || browser.name}</td>
                                            <td className="py-4 px-4 text-white opacity-90">{browser.phoneNumber || 'N/A'}</td>
                                            <td className="py-4 px-4">
                                                <span className={`font-bold ${getRentalColor(browser.rentalRemaining)}`}>
                                                    {formatRentalTime(browser.rentalRemaining)}
                                                </span>
                                            </td>
                                            <td className="py-4 px-4">
                                                <div className="flex gap-2 justify-center">
                                                    <button
                                                        onClick={() => setSelectedBrowser(browser)}
                                                        className="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold text-sm"
                                                    >
                                                        Ver
                                                    </button>
                                                    <button
                                                        onClick={() => handleCopyLink(browser)}
                                                        className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-1"
                                                    >
                                                        <Link /> Link
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            
                            {browserList.length === 0 && (
                                <div className="text-center py-12 text-white opacity-75">
                                    No hay usuarios. Crea uno arriba.
                                </div>
                            )}
                        </div>
                    </div>

                    {selectedBrowser && (
                        <Dashboard
                            browserData={selectedBrowser}
                            onClose={() => setSelectedBrowser(null)}
                        />
                    )}
                </div>
            );
        };

        // ==================== CHATBOT ====================
        const Chatbot = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');

            useEffect(() => {
                if (isOpen && messages.length === 0) {
                    setMessages([{ text: "üëã ¬°Hola! ¬øEn qu√© puedo ayudarte?", sender: 'bot' }]);
                }
            }, [isOpen]);

            const handleSend = () => {
                if (!input.trim()) return;
                setMessages(prev => [...prev, { text: input.trim(), sender: 'user' }]);
                setInput('');
                setTimeout(() => {
                    setMessages(prev => [...prev, { text: `Contacta:\nüì± +1 ${CONTACT.whatsapp}\nüìß ${CONTACT.email}`, sender: 'bot' }]);
                }, 500);
            };

            return (
                <>
                    {!isOpen && (
                        <button onClick={() => setIsOpen(true)}
                            className="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform z-50 animate-pulse-glow">
                            <MessageCircle />
                        </button>
                    )}

                    {isOpen && (
                        <div className="fixed bottom-6 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col z-50">
                            <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
                                <h3 className="font-bold">Chat</h3>
                                <button onClick={() => setIsOpen(false)} className="hover:bg-white hover:bg-opacity-20 p-2 rounded-full">
                                    <X />
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] p-3 rounded-2xl ${
                                            msg.sender === 'user' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-800'
                                        }`}>
                                            <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="p-4 border-t flex gap-2">
                                <input type="text" value={input} onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="Escribe..."
                                    className="flex-1 px-4 py-2 border rounded-xl" />
                                <button onClick={handleSend} className="bg-purple-600 text-white p-3 rounded-xl"><Send /></button>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // ==================== DASHBOARD - OPCI√ìN 1: MODAL LOCAL ====================
        const Dashboard = ({ browserData, onClose }) => {
            const [liveData, setLiveData] = useState(browserData);
            const [actionLoading, setActionLoading] = useState(false);
            const [screenshot, setScreenshot] = useState(null);
            const [showEditForm, setShowEditForm] = useState(false);
            const [showCaptchaForm, setShowCaptchaForm] = useState(false);
            const [captchaCode, setCaptchaCode] = useState('');
            const [showSuccessMessage, setShowSuccessMessage] = useState(false);
            
            const [editForm, setEditForm] = useState({
                name: '',
                age: '',
                headline: '',
                body: '',
                city: '',
                location: ''
            });
            
            // SOLUCI√ìN DEFINITIVA: Ignorar Firebase despu√©s de abrir el modal
            const modalManuallyControlledRef = useRef(false);
            const commandInProgressRef = useRef(false);
            const previousRepublishRef = useRef(null);

            useEffect(() => {
                const unsubscribe = FirebaseAPI.listenToBrowser(browserData.browserName || browserData.name, (newData) => {
                    if (previousRepublishRef.current && newData.republishStatus) {
                        if (previousRepublishRef.current.elapsedSeconds > 800 && newData.republishStatus.elapsedSeconds < 10) {
                            playSuccessSound();
                            createConfetti();
                            // Mostrar mensaje de √©xito
                            setShowSuccessMessage(true);
                            setTimeout(() => setShowSuccessMessage(false), 5000);
                        }
                    }
                    if (newData.republishStatus) {
                        previousRepublishRef.current = newData.republishStatus;
                    }
                    
                    // Si el modal ya est√° siendo controlado manualmente, IGNORAR Firebase
                    if (modalManuallyControlledRef.current) {
                        return;
                    }
                    
                    // Solo abrir el modal si captchaWaiting es true
                    if (newData.captchaWaiting && !showCaptchaForm) {
                        console.log('‚úÖ Abriendo modal de captcha');
                        setShowCaptchaForm(true);
                        modalManuallyControlledRef.current = true; // Ahora ignorar Firebase
                    }
                    
                    setLiveData(newData);
                });
                
                return unsubscribe;
            }, [browserData.browserName, browserData.name, showCaptchaForm]);

            const executeAction = async (actionType, payload = {}) => {
                // FIX 2: Prevenir m√∫ltiples ejecuciones simult√°neas
                if (commandInProgressRef.current || actionLoading) {
                    console.log('Comando ya en proceso, ignorando...');
                    return;
                }
                
                commandInProgressRef.current = true;
                setActionLoading(true);
                
                try {
                    const result = await FirebaseAPI.sendCommand(liveData.browserName || liveData.name, actionType, payload);
                    
                    if (result.success) {
                        if (actionType === 'pause') {
                            alert(liveData.isPaused ? '‚ñ∂Ô∏è Sistema reanudado' : '‚è∏Ô∏è Sistema pausado');
                        } else if (actionType === 'republish') {
                            alert('üîÑ Republicando...');
                        } else if (actionType === 'screenshot') {
                            alert('üì∏ Capturando...');
                            
                            let attempts = 0;
                            const checkScreenshot = setInterval(async () => {
                                attempts++;
                                const data = await FirebaseAPI.findBrowserByName(liveData.browserName || liveData.name);
                                
                                if (data && data.lastScreenshot) {
                                    clearInterval(checkScreenshot);
                                    setScreenshot(data.lastScreenshot);
                                    setActionLoading(false);
                                    commandInProgressRef.current = false;
                                } else if (attempts >= 10) {
                                    clearInterval(checkScreenshot);
                                    alert('‚ùå No se recibi√≥ screenshot');
                                    setActionLoading(false);
                                    commandInProgressRef.current = false;
                                }
                            }, 1000);
                            
                            return;
                        }
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } finally {
                    setActionLoading(false);
                    commandInProgressRef.current = false;
                }
            };

            const handleOpenEditor = () => {
                setEditForm({
                    name: '',
                    age: '',
                    headline: '',
                    body: '',
                    city: '',
                    location: ''
                });
                setShowEditForm(true);
            };

            const handleSaveAllEdits = async () => {
                // FIX 2: Prevenir m√∫ltiples guardados
                if (commandInProgressRef.current || actionLoading) {
                    console.log('Guardado ya en proceso, ignorando...');
                    return;
                }
                
                const changes = {};
                if (editForm.name.trim()) changes.name = editForm.name.trim();
                if (editForm.age.trim()) changes.age = editForm.age.trim();
                if (editForm.headline.trim()) changes.headline = editForm.headline.trim();
                if (editForm.body.trim()) changes.body = editForm.body.trim();
                if (editForm.city.trim()) changes.city = editForm.city.trim();
                if (editForm.location.trim()) changes.location = editForm.location.trim();
                
                if (Object.keys(changes).length === 0) {
                    alert('‚ùå Debes cambiar al menos un campo');
                    return;
                }
                
                if (changes.age) {
                    const age = parseInt(changes.age);
                    if (isNaN(age) || age < 18 || age > 99) {
                        alert('‚ùå Edad debe ser 18-99');
                        return;
                    }
                }
                
                if (changes.headline && changes.headline.length > 250) {
                    alert(`‚ùå Encabezado muy largo (${changes.headline.length}/250)`);
                    return;
                }
                
                if (changes.body && changes.body.length > 2000) {
                    alert(`‚ùå Cuerpo muy largo (${changes.body.length}/2000)`);
                    return;
                }
                
                commandInProgressRef.current = true;
                setActionLoading(true);
                
                try {
                    const result = await FirebaseAPI.sendCommand(
                        liveData.browserName || liveData.name,
                        'edit_multiple_fields',
                        { changes }
                    );
                    
                    if (result.success) {
                        alert('‚úÖ Edici√≥n iniciada. La extensi√≥n procesar√° todos los cambios autom√°ticamente.');
                        setShowEditForm(false);
                        setEditForm({
                            name: '',
                            age: '',
                            headline: '',
                            body: '',
                            city: '',
                            location: ''
                        });
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } finally {
                    setActionLoading(false);
                    commandInProgressRef.current = false;
                }
            };

            const handleCaptchaSubmit = async () => {
                if (!captchaCode.trim()) {
                    alert('‚ùå Escribe el c√≥digo');
                    return;
                }
                
                if (commandInProgressRef.current || actionLoading) {
                    return;
                }
                
                commandInProgressRef.current = true;
                setActionLoading(true);
                
                try {
                    const result = await FirebaseAPI.sendCommand(
                        liveData.browserName || liveData.name,
                        'submit_captcha',
                        { code: captchaCode.trim() }
                    );
                    
                    if (result.success) {
                        alert('‚úÖ C√≥digo enviado');
                        // Cerrar modal despu√©s de 1 segundo
                        setTimeout(() => {
                            setShowCaptchaForm(false);
                            setCaptchaCode('');
                            modalManuallyControlledRef.current = false;
                        }, 1000);
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } finally {
                    setActionLoading(false);
                    commandInProgressRef.current = false;
                }
            };
            
            const handleCaptchaCancel = () => {
                setShowCaptchaForm(false);
                setCaptchaCode('');
                modalManuallyControlledRef.current = false;
            };

            const progressPercent = liveData.republishStatus ? 
                (liveData.republishStatus.elapsedSeconds / liveData.republishStatus.totalSeconds) * 100 : 0;

            return (
                <>
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 max-w-2xl w-full my-8 shadow-2xl border-4 border-purple-200">
                            <div className="space-y-6">
                                <div className="text-center">
                                    <h2 className="text-4xl font-bold mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                        üì± {liveData.browserName || liveData.name}
                                    </h2>
                                    <div className="flex gap-2 justify-center flex-wrap">
                                        <span className={`px-6 py-3 rounded-full text-sm font-bold shadow-lg ${
                                            liveData.isPaused ? 'bg-orange-500 text-white' : 'bg-green-500 text-white'
                                        }`}>
                                            {liveData.isPaused ? '‚è∏Ô∏è Pausado' : '‚ñ∂Ô∏è Activo'}
                                        </span>
                                        {liveData.editInProgress && (
                                            <span className="px-6 py-3 rounded-full text-sm font-bold shadow-lg bg-blue-500 text-white">
                                                ‚úèÔ∏è Editando
                                            </span>
                                        )}
                                    </div>
                                </div>

                                {liveData.editLog && (
                                    <div className={`rounded-2xl p-4 shadow-lg border-2 ${
                                        liveData.editLogType === 'error' ? 'bg-red-100 border-red-300' :
                                        liveData.editLogType === 'success' ? 'bg-green-100 border-green-300' :
                                        'bg-blue-100 border-blue-300'
                                    }`}>
                                        <p className="font-bold text-center">{liveData.editLog}</p>
                                    </div>
                                )}

                                {!liveData.manuallyCreated && (
                                    <div className="bg-white rounded-2xl p-6 shadow-lg border-2 border-purple-100">
                                        <h3 className="font-bold mb-3 text-lg">üìã Info</h3>
                                        <div className="space-y-2">
                                            <p><strong>üìû:</strong> {liveData.phoneNumber}</p>
                                            <p><strong>üèôÔ∏è:</strong> {liveData.city}</p>
                                            <p><strong>üìç:</strong> {liveData.location}</p>
                                        </div>
                                    </div>
                                )}

                                {liveData.republishStatus && (
                                    <div className={`bg-gradient-to-br from-pink-100 to-purple-100 rounded-2xl p-6 shadow-lg border-2 border-pink-200 ${liveData.isPaused ? 'paused-overlay' : ''}`}>
                                        {/* Mostrar diferentes t√≠tulos seg√∫n el estado */}
                                        {liveData.editInProgress ? (
                                            <h3 className="font-bold mb-4 text-lg">‚úèÔ∏è Editando Post</h3>
                                        ) : showSuccessMessage ? (
                                            <h3 className="font-bold mb-4 text-lg">‚úÖ Republicaci√≥n Exitosa</h3>
                                        ) : (
                                            <h3 className="font-bold mb-4 text-lg">‚è±Ô∏è Pr√≥xima Republicaci√≥n</h3>
                                        )}
                                        
                                        <div className="text-center mb-6">
                                            <div className="text-6xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                                {liveData.editInProgress ? (
                                                    '‚úèÔ∏è'
                                                ) : showSuccessMessage ? (
                                                    'üéâ'
                                                ) : liveData.isPaused ? (
                                                    '‚è∏Ô∏è'
                                                ) : (
                                                    formatTime(liveData.republishStatus.remainingSeconds)
                                                )}
                                            </div>
                                            
                                            {/* Mostrar mensaje de proceso de edici√≥n */}
                                            {liveData.editInProgress && liveData.editLog && (
                                                <p className="text-sm mt-4 text-gray-700 font-medium">{liveData.editLog}</p>
                                            )}
                                            
                                            {/* Mostrar mensaje de √©xito */}
                                            {showSuccessMessage && (
                                                <p className="text-lg mt-4 text-green-700 font-bold">¬°El post se ha republicado exitosamente!</p>
                                            )}
                                        </div>
                                        
                                        <div className="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                                            <div 
                                                className="bg-gradient-to-r from-purple-500 to-pink-500 h-full progress-bar rounded-full"
                                                style={{ width: `${Math.min(progressPercent, 100)}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl p-6 shadow-lg border-2 border-blue-200">
                                    <div className="flex justify-between">
                                        <span className="font-bold text-lg">üí∞ Renta:</span>
                                        <span className={`font-bold text-xl ${getRentalColor(liveData.rentalRemaining)}`}>
                                            {formatRentalTime(liveData.rentalRemaining)}
                                        </span>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl p-6 shadow-lg border-2 border-gray-100">
                                    <h3 className="font-bold mb-4 text-lg">‚öôÔ∏è Controles</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button 
                                            onClick={() => executeAction('pause')} 
                                            disabled={actionLoading || commandInProgressRef.current}
                                            className={`flex flex-col items-center gap-2 px-6 py-5 rounded-2xl font-bold text-white shadow-lg ${
                                                liveData.isPaused ? 'bg-gradient-to-br from-green-500 to-emerald-600' : 'bg-gradient-to-br from-orange-500 to-red-600'
                                            } disabled:opacity-50 disabled:cursor-not-allowed`}>
                                            {liveData.isPaused ? <Play /> : <Pause />}
                                            <span className="text-sm">{liveData.isPaused ? 'Reanudar' : 'Pausar'}</span>
                                        </button>
                                        
                                        <button 
                                            onClick={() => executeAction('republish')} 
                                            disabled={actionLoading || liveData.isPaused || commandInProgressRef.current}
                                            className="flex flex-col items-center gap-2 bg-gradient-to-br from-blue-500 to-indigo-600 text-white px-6 py-5 rounded-2xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                            <RefreshCw />
                                            <span className="text-sm">Republicar</span>
                                        </button>
                                        
                                        <button 
                                            onClick={() => executeAction('screenshot')} 
                                            disabled={actionLoading || commandInProgressRef.current}
                                            className="flex flex-col items-center gap-2 bg-gradient-to-br from-purple-500 to-pink-600 text-white px-6 py-5 rounded-2xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Camera />
                                            <span className="text-sm">Foto</span>
                                        </button>
                                        
                                        <button 
                                            onClick={handleOpenEditor} 
                                            disabled={actionLoading || liveData.editInProgress || commandInProgressRef.current}
                                            className="flex flex-col items-center gap-2 bg-gradient-to-br from-yellow-500 to-orange-600 text-white px-6 py-5 rounded-2xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Edit />
                                            <span className="text-sm">{liveData.editInProgress ? 'Editando...' : 'Editar'}</span>
                                        </button>
                                    </div>
                                </div>

                                <button 
                                    onClick={onClose} 
                                    className="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-4 rounded-2xl font-bold shadow-lg">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Modal de Edici√≥n Estilo Megapersonals */}
                    {showEditForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4 overflow-y-auto">
                            <div className="bg-gradient-to-br from-pink-400 via-pink-500 to-pink-600 rounded-3xl p-8 max-w-3xl w-full shadow-2xl my-8">
                                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl p-6">
                                    <h2 className="text-3xl font-bold text-white text-center mb-6 drop-shadow-lg">
                                        ‚úèÔ∏è EDITAR POST
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                Name/Alias:
                                            </label>
                                            <input
                                                type="text"
                                                value={editForm.name}
                                                onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                                                placeholder="Deja vac√≠o si no quieres cambiar"
                                                maxLength="50"
                                                className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300"
                                            />
                                            {editForm.name && (
                                                <p className="text-xs text-white mt-1">{editForm.name.length}/50 caracteres</p>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                Age:
                                            </label>
                                            <select
                                                value={editForm.age}
                                                onChange={(e) => setEditForm({...editForm, age: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300"
                                            >
                                                <option value="">-- No cambiar --</option>
                                                {Array.from({length: 82}, (_, i) => i + 18).map(age => (
                                                    <option key={age} value={age}>{age}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                Headline:
                                            </label>
                                            <input
                                                type="text"
                                                value={editForm.headline}
                                                onChange={(e) => setEditForm({...editForm, headline: e.target.value})}
                                                placeholder="Deja vac√≠o si no quieres cambiar"
                                                maxLength="250"
                                                className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300"
                                            />
                                            {editForm.headline && (
                                                <p className="text-xs text-white mt-1">{editForm.headline.length}/250 caracteres</p>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                Body:
                                            </label>
                                            <textarea
                                                value={editForm.body}
                                                onChange={(e) => setEditForm({...editForm, body: e.target.value})}
                                                placeholder="Deja vac√≠o si no quieres cambiar"
                                                rows="6"
                                                maxLength="2000"
                                                className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300 resize-none"
                                            />
                                            {editForm.body && (
                                                <p className="text-xs text-white mt-1">{editForm.body.length}/2000 caracteres</p>
                                            )}
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                    City:
                                                </label>
                                                <input
                                                    type="text"
                                                    value={editForm.city}
                                                    onChange={(e) => setEditForm({...editForm, city: e.target.value})}
                                                    placeholder="No cambiar"
                                                    maxLength="100"
                                                    className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-white font-bold mb-2 drop-shadow text-lg">
                                                    Location/Area:
                                                </label>
                                                <input
                                                    type="text"
                                                    value={editForm.location}
                                                    onChange={(e) => setEditForm({...editForm, location: e.target.value})}
                                                    placeholder="No cambiar"
                                                    maxLength="100"
                                                    className="w-full px-4 py-3 border-2 border-white rounded-xl text-lg shadow-lg focus:ring-4 focus:ring-pink-300"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 mt-8">
                                        <button
                                            onClick={handleSaveAllEdits}
                                            disabled={actionLoading || commandInProgressRef.current}
                                            className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-5 rounded-2xl font-bold text-xl shadow-2xl hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {actionLoading ? '‚è≥ Guardando...' : '‚úÖ GUARDAR CAMBIOS'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowEditForm(false);
                                                setEditForm({
                                                    name: '',
                                                    age: '',
                                                    headline: '',
                                                    body: '',
                                                    city: '',
                                                    location: ''
                                                });
                                            }}
                                            disabled={actionLoading || commandInProgressRef.current}
                                            className="flex-1 bg-gray-600 text-white px-8 py-5 rounded-2xl font-bold text-xl shadow-2xl hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            ‚ùå CANCELAR
                                        </button>
                                    </div>

                                    <p className="text-sm text-white text-center mt-4 drop-shadow">
                                        üí° Solo llena los campos que quieras cambiar. Los dem√°s quedar√°n igual.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Captcha - FIX: Mostrar SOLO si showCaptchaForm es true */}
                    {showCaptchaForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-lg w-full shadow-2xl">
                                <h3 className="text-2xl font-bold mb-6 text-center">üîê C√≥digo de Seguridad</h3>
                                
                                {liveData.captchaImage && (
                                    <div className="mb-6 text-center">
                                        <img 
                                            src={liveData.captchaImage} 
                                            alt="Captcha" 
                                            className="mx-auto rounded-xl shadow-lg border-4 border-purple-200 max-w-full"
                                        />
                                    </div>
                                )}
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block font-bold mb-2 text-center">
                                            Escribe los caracteres que ves:
                                        </label>
                                        <input
                                            type="text"
                                            value={captchaCode}
                                            onChange={(e) => setCaptchaCode(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && !actionLoading && !commandInProgressRef.current && handleCaptchaSubmit()}
                                            placeholder="Ejemplo: 3uK>"
                                            className="w-full px-4 py-3 border-2 rounded-xl text-lg text-center font-mono"
                                            autoFocus
                                            disabled={actionLoading || commandInProgressRef.current}
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={handleCaptchaSubmit}
                                        disabled={actionLoading || !captchaCode.trim() || commandInProgressRef.current}
                                        className="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-4 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {actionLoading ? '‚è≥ Verificando...' : '‚úÖ Enviar'}
                                    </button>
                                    <button
                                        onClick={handleCaptchaCancel}
                                        disabled={actionLoading || commandInProgressRef.current}
                                        className="flex-1 bg-gray-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Cancelar
                                    </button>
                                </div>

                                <p className="text-sm text-gray-600 mt-4 text-center">
                                    ‚ÑπÔ∏è La extensi√≥n guardar√° los cambios autom√°ticamente despu√©s de verificar el c√≥digo
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Modal de Screenshot */}
                    {screenshot && (
                        <div className="screenshot-modal" onClick={() => setScreenshot(null)}>
                            <div className="relative">
                                <button 
                                    onClick={() => setScreenshot(null)}
                                    className="absolute top-4 right-4 bg-white text-black p-3 rounded-full shadow-lg">
                                    <X />
                                </button>
                                <img src={screenshot} alt="Screenshot" />
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // ==================== APP ====================
        const App = () => {
            const [currentView, setCurrentView] = useState('home');
            const [phoneSearch, setPhoneSearch] = useState('');
            const [browserData, setBrowserData] = useState(null);
            const [searching, setSearching] = useState(false);
            const [error, setError] = useState('');
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('id');
                const userName = urlParams.get('user'); // Mantener compatibilidad con links viejos
                
                if (userId) {
                    setCurrentView('control');
                    loadUserById(userId);
                } else if (userName) {
                    setCurrentView('control');
                    loadUserByName(userName);
                } else {
                    setLoading(false);
                }
            }, []);

            const loadUserById = async (userId) => {
                setLoading(true);
                const data = await FirebaseAPI.findBrowserByUniqueId(userId);
                if (data) {
                    setBrowserData(data);
                } else {
                    setError(`Usuario no encontrado`);
                }
                setLoading(false);
            };

            const loadUserByName = async (userName) => {
                setLoading(true);
                const data = await FirebaseAPI.findBrowserByName(userName);
                if (data) {
                    setBrowserData(data);
                } else {
                    setError(`Usuario "${userName}" no encontrado`);
                }
                setLoading(false);
            };

            const handleSearch = async () => {
                if (!phoneSearch.trim()) {
                    setError('Ingresa un n√∫mero');
                    return;
                }

                setSearching(true);
                setError('');
                setBrowserData(null);

                const data = await FirebaseAPI.findBrowser(phoneSearch);
                if (data) setBrowserData(data);
                else setError('No se encontr√≥');

                setSearching(false);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-700 via-pink-600 to-red-600 flex items-center justify-center">
                        <div className="text-white text-2xl animate-pulse">Cargando...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-700 via-pink-600 to-red-600 animate-gradient">
                    <div className="container mx-auto px-4 py-12 text-center">
                        <div className="animate-float mb-8">
                            <div className="text-8xl mb-4">üî•</div>
                        </div>
                        <h1 className="text-6xl font-bold text-white mb-4">Megapersonals Premium</h1>
                        <p className="text-2xl text-white opacity-90">üî• Servicio #1</p>
                    </div>

                    <div className="container mx-auto px-4 mb-8">
                        <div className="flex justify-center gap-4 flex-wrap">
                            <button onClick={() => setCurrentView('home')}
                                className={`px-8 py-3 rounded-xl font-bold transition-all ${
                                    currentView === 'home' ? 'bg-white text-purple-600 shadow-xl scale-110' : 'glass text-white hover:scale-105'
                                }`}>
                                üè† Inicio
                            </button>
                            <button onClick={() => setCurrentView('control')}
                                className={`px-8 py-3 rounded-xl font-bold transition-all ${
                                    currentView === 'control' ? 'bg-white text-purple-600 shadow-xl scale-110' : 'glass text-white hover:scale-105'
                                }`}>
                                üéõÔ∏è Panel
                            </button>
                            <button onClick={() => setCurrentView('admin')}
                                className={`px-8 py-3 rounded-xl font-bold transition-all ${
                                    currentView === 'admin' ? 'bg-white text-purple-600 shadow-xl scale-110' : 'glass text-white hover:scale-105'
                                }`}>
                                üë®‚Äçüíº Admin
                            </button>
                        </div>
                    </div>

                    <div className="container mx-auto px-4 pb-12">
                        {currentView === 'home' && (
                            <div className="grid md:grid-cols-3 gap-8">
                                {SERVICES.map((s) => (
                                    <div key={s.id} className="glass rounded-3xl p-8 hover:scale-105 transition-all shadow-2xl">
                                        <div className="text-6xl mb-4 text-center">{s.icon}</div>
                                        <h3 className="text-2xl font-bold text-white mb-2 text-center">{s.title}</h3>
                                        <p className="text-white opacity-90 text-center mb-4">{s.subtitle}</p>
                                        <p className="text-white opacity-75 mb-6">{s.description}</p>
                                        <div className="space-y-2 mb-6">
                                            {s.features.map((f, i) => (
                                                <div key={i} className="flex items-center text-white">
                                                    <span className="mr-2">‚úì</span> {f}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-center">
                                            <p className="text-3xl font-bold text-white mb-2">{s.price}</p>
                                            <p className="text-white opacity-75">Stock: {s.stock}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentView === 'control' && (
                            <div className="glass rounded-3xl p-8 max-w-2xl mx-auto shadow-2xl">
                                <h2 className="text-3xl font-bold text-white mb-6 text-center">üéõÔ∏è Panel de Control</h2>
                                <div className="space-y-4">
                                    <div className="flex gap-3">
                                        <input type="text" value={phoneSearch} onChange={(e) => setPhoneSearch(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                            placeholder="N√∫mero"
                                            className="flex-1 px-6 py-4 rounded-xl text-lg shadow-lg"
                                            disabled={searching} />
                                        <button onClick={handleSearch} disabled={searching}
                                            className="bg-green-500 text-white px-8 py-4 rounded-xl font-bold shadow-lg flex items-center gap-2">
                                            <Search /> {searching ? 'Buscando...' : 'Buscar'}
                                        </button>
                                    </div>
                                    {error && (
                                        <div className="bg-red-100 border-2 border-red-300 text-red-700 px-6 py-4 rounded-xl shadow-lg">
                                            ‚ö†Ô∏è {error}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'admin' && (
                            <AdminPanel
                                isAuthenticated={isAdminAuthenticated}
                                onLogin={() => setIsAdminAuthenticated(true)}
                            />
                        )}
                    </div>

                    <Chatbot />
                    {browserData && <Dashboard browserData={browserData} onClose={() => setBrowserData(null)} />}

                    <div className="container mx-auto px-4 py-8 text-center text-white">
                        <p className="text-xl mb-2">üì± WhatsApp: +1 {CONTACT.whatsapp}</p>
                        <p>üìß {CONTACT.email}</p>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>