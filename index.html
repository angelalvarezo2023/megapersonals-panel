<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megapersonals Premium - Panel de Control</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== FIREBASE SETUP ====================
        const firebaseConfig = {
            databaseURL: "https://megapersonals-4f24c-default-rtdb.firebaseio.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        console.log("üî• Firebase conectado");

        // ==================== FIREBASE API ====================
        const FirebaseAPI = {
            async findBrowser(phoneNumber) {
                try {
                    const snapshot = await database.ref('browsers').once('value');
                    const browsers = snapshot.val();
                    
                    if (!browsers) {
                        console.log("No hay navegadores en Firebase");
                        return null;
                    }
                    
                    const cleanPhone = phoneNumber.replace(/\D/g, '');
                    console.log("Buscando:", cleanPhone);
                    
                    for (const [name, data] of Object.entries(browsers)) {
                        const browserPhone = (data.phoneNumber || '').replace(/\D/g, '');
                        console.log(`Comparando con ${name}:`, browserPhone);
                        
                        if (browserPhone.includes(cleanPhone) || cleanPhone.includes(browserPhone)) {
                            console.log("‚úÖ Encontrado:", name);
                            return data;
                        }
                    }
                    
                    console.log("‚ùå No encontrado");
                    return null;
                } catch (error) {
                    console.error('Error buscando:', error);
                    return null;
                }
            },
            
            async sendCommand(browserName, actionType, payload = {}) {
                try {
                    const commandId = Date.now().toString();
                    await database.ref(`commands/${browserName}/${commandId}`).set({
                        type: actionType,
                        ...payload,
                        timestamp: new Date().toISOString()
                    });
                    console.log(`‚úÖ Comando enviado: ${actionType} a ${browserName}`);
                    return { success: true };
                } catch (error) {
                    console.error('Error enviando comando:', error);
                    return { success: false, error: error.message };
                }
            },
            
            listenToBrowser(browserName, callback) {
                const ref = database.ref(`browsers/${browserName}`);
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        callback(data);
                    }
                });
                return () => ref.off('value');
            }
        };

        // ==================== ICONOS ====================
        const Search = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const Pause = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        );

        const Play = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        const RefreshCw = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const Camera = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
        );

        // ==================== UTILIDADES ====================
        const formatTime = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        };

        const formatRentalTime = (rental) => {
            if (rental.days === -1) return "Sin renta configurada";
            if (rental.days === 0 && rental.hours === 0 && rental.minutes === 0) return "Expirada";
            
            const parts = [];
            if (rental.days > 0) parts.push(`${rental.days} d√≠a${rental.days > 1 ? 's' : ''}`);
            if (rental.hours > 0) parts.push(`${rental.hours} hora${rental.hours > 1 ? 's' : ''}`);
            if (rental.minutes > 0) parts.push(`${rental.minutes} min`);
            
            return parts.join(', ');
        };

        // ==================== DASHBOARD ====================
        const Dashboard = ({ browserData, onClose }) => {
            const [actionLoading, setActionLoading] = useState(false);
            const [liveData, setLiveData] = useState(browserData);

            useEffect(() => {
                // Escuchar cambios en tiempo real
                const unsubscribe = FirebaseAPI.listenToBrowser(browserData.browserName, (newData) => {
                    setLiveData(newData);
                });
                
                return unsubscribe;
            }, [browserData.browserName]);

            const executeAction = async (actionType, payload = {}) => {
                setActionLoading(true);
                
                try {
                    const result = await FirebaseAPI.sendCommand(liveData.browserName, actionType, payload);
                    
                    if (result.success) {
                        alert(`‚úÖ Comando "${actionType}" enviado`);
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`‚ùå Error: ${error.message}`);
                }
                
                setActionLoading(false);
            };

            const progressPercent = (liveData.republishStatus.elapsedSeconds / liveData.republishStatus.totalSeconds) * 100;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                        <div className="space-y-6">
                            {/* Header */}
                            <div className="text-center">
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">
                                    üì± {liveData.browserName}
                                </h2>
                                <div className="flex items-center justify-center gap-2">
                                    <span className={`px-4 py-2 rounded-full text-sm font-bold ${
                                        liveData.isPaused ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'
                                    }`}>
                                        {liveData.isPaused ? '‚è∏ Pausado' : '‚ñ∂Ô∏è Activo'}
                                    </span>
                                </div>
                            </div>

                            {/* Info */}
                            <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 border-2 border-purple-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-3">üìã Informaci√≥n del Post</h3>
                                <div className="space-y-2 text-sm">
                                    <p><strong>üìû Tel√©fono:</strong> {liveData.phoneNumber}</p>
                                    <p><strong>üèôÔ∏è Ciudad:</strong> {liveData.city}</p>
                                    <p><strong>üìç Ubicaci√≥n:</strong> {liveData.location}</p>
                                </div>
                            </div>

                            {/* Countdown */}
                            <div className="bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl p-6 border-2 border-pink-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-3">‚è±Ô∏è Pr√≥xima Republicaci√≥n</h3>
                                
                                <div className="text-center mb-4">
                                    <div className="text-5xl font-bold text-purple-600 mb-2">
                                        <span className="animate-pulse-glow">
                                            {formatTime(liveData.republishStatus.remainingSeconds)}
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div 
                                        className="bg-gradient-to-r from-purple-500 to-pink-500 h-full progress-bar animate-pulse-glow"
                                        style={{ width: `${Math.min(progressPercent, 100)}%` }}
                                    ></div>
                                </div>
                                
                                <p className="text-sm text-gray-600 mt-2 text-center">
                                    {liveData.republishStatus.elapsedSeconds}s / {liveData.republishStatus.totalSeconds}s
                                </p>
                            </div>

                            {/* Renta */}
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border-2 border-blue-200">
                                <div className="flex items-center justify-between">
                                    <span className="text-gray-700 font-semibold">üí∞ Tiempo de renta:</span>
                                    <span className={`text-lg font-bold ${
                                        liveData.rentalRemaining.days > 0 ? 'text-green-600' :
                                        liveData.rentalRemaining.hours > 0 ? 'text-orange-600' :
                                        'text-red-600'
                                    }`}>
                                        {formatRentalTime(liveData.rentalRemaining)}
                                    </span>
                                </div>
                            </div>

                            {/* Controles */}
                            <div className="bg-white rounded-2xl p-6 shadow-lg border-2 border-purple-200">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Controles</h3>
                                
                                <div className="grid md:grid-cols-3 gap-3">
                                    <button
                                        onClick={() => executeAction('pause')}
                                        disabled={actionLoading}
                                        className={`flex items-center justify-center gap-2 px-6 py-4 rounded-xl font-bold text-white transition-all ${
                                            liveData.isPaused
                                                ? 'bg-gradient-to-r from-green-500 to-emerald-600 hover:shadow-xl'
                                                : 'bg-gradient-to-r from-orange-500 to-red-600 hover:shadow-xl'
                                        } disabled:opacity-50`}
                                    >
                                        {liveData.isPaused ? <Play /> : <Pause />}
                                        {liveData.isPaused ? 'Reanudar' : 'Pausar'}
                                    </button>

                                    <button
                                        onClick={() => executeAction('republish')}
                                        disabled={actionLoading || liveData.isPaused}
                                        className="flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-4 rounded-xl font-bold hover:shadow-xl transition-all disabled:opacity-50"
                                    >
                                        <RefreshCw />
                                        Republicar
                                    </button>

                                    <button
                                        onClick={() => executeAction('screenshot')}
                                        disabled={actionLoading}
                                        className="flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-pink-600 text-white px-6 py-4 rounded-xl font-bold hover:shadow-xl transition-all disabled:opacity-50"
                                    >
                                        <Camera />
                                        Foto
                                    </button>
                                </div>
                            </div>

                            <button
                                onClick={onClose}
                                className="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-4 rounded-xl font-bold hover:shadow-xl transition-all"
                            >
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== APP PRINCIPAL ====================
        const App = () => {
            const [phoneSearch, setPhoneSearch] = useState('');
            const [browserData, setBrowserData] = useState(null);
            const [searching, setSearching] = useState(false);
            const [error, setError] = useState('');

            const handleSearch = async () => {
                if (!phoneSearch.trim()) {
                    setError('Ingresa un n√∫mero de tel√©fono');
                    return;
                }

                setSearching(true);
                setError('');
                setBrowserData(null);

                try {
                    const data = await FirebaseAPI.findBrowser(phoneSearch);
                    
                    if (data) {
                        setBrowserData(data);
                    } else {
                        setError('No se encontr√≥ ninguna cuenta con ese n√∫mero');
                    }
                } catch (error) {
                    setError('Error al buscar: ' + error.message);
                }

                setSearching(false);
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="max-w-4xl w-full">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-bold text-white mb-4">
                                Megapersonals Premium
                            </h1>
                            <p className="text-xl text-white opacity-90">
                                üî• Servicio Profesional #1
                            </p>
                            <p className="text-white opacity-75">
                                Las mejores cuentas, proxies y panel de control
                            </p>
                        </div>

                        {/* Panel de Control */}
                        <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white border-opacity-20">
                            <div className="text-center mb-6">
                                <h2 className="text-3xl font-bold text-white mb-2">
                                    üéõÔ∏è Panel de Control
                                </h2>
                                <p className="text-white opacity-90">
                                    Administra tu cuenta de Megapersonals
                                </p>
                            </div>

                            <div className="space-y-4">
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={phoneSearch}
                                        onChange={(e) => setPhoneSearch(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                        placeholder="Ingresa tu n√∫mero (ej: 123 456 7890)"
                                        className="flex-1 px-6 py-4 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-purple-300"
                                        disabled={searching}
                                    />
                                    <button
                                        onClick={handleSearch}
                                        disabled={searching}
                                        className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-4 rounded-xl font-bold hover:shadow-xl transition-all disabled:opacity-50 flex items-center gap-2"
                                    >
                                        <Search />
                                        {searching ? 'Buscando...' : 'Buscar'}
                                    </button>
                                </div>

                                {error && (
                                    <div className="bg-red-100 border-2 border-red-300 text-red-700 px-6 py-4 rounded-xl">
                                        ‚ö†Ô∏è {error}
                                    </div>
                                )}

                                <p className="text-white text-center text-sm opacity-75">
                                    üí° Ingres√° el n√∫mero de tel√©fono de tu post para ver su estado y controles
                                </p>
                            </div>
                        </div>
                    </div>

                    {browserData && (
                        <Dashboard 
                            browserData={browserData}
                            onClose={() => setBrowserData(null)}
                        />
                    )}
                </div>
            );
        };

        // Renderizar
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>